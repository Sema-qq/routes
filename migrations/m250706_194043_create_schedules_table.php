<?php

use yii\db\Migration;

/**
 * Handles the creation of table `{{%schedules}}`.
 */
class m250706_194043_create_schedules_table extends Migration
{
    public function safeUp(): void
    {
        $this->createTable('schedules', [
            'id' => $this->primaryKey(),
            'date' => $this->date()->notNull(),
            'car_id' => $this->integer()->notNull(),
            'route_id' => $this->integer()->notNull(),
            'stop_id' => $this->integer()->notNull(),
            'stop_number' => $this->integer()->notNull(),
            'planned_time' => $this->time(),
            'actual_time' => $this->time(),
            'boarded_count' => $this->integer()->defaultValue(0)
        ]);

        // foreign keys
        $this->addForeignKey('fk-schedules-cars',
            'schedules',
            'car_id',
            'cars',
            'id',
            'CASCADE');
        $this->addForeignKey('fk-schedules-route',
            'schedules',
            'route_id',
            'routes',
            'id',
            'CASCADE');
        $this->addForeignKey('fk-schedules-stop',
            'schedules',
            'stop_id',
            'stops',
            'id',
            'CASCADE');

        // 1. stop_number только 1–10
        $this->execute('ALTER TABLE {{%schedules}} ADD CONSTRAINT chk_stop_number_range CHECK (stop_number BETWEEN 1 AND 10)');

        // 2. Уникальность полей (date, route_id, stop_number)
        $this->createIndex(
            'idx-unique-schedule',
            'schedules',
            ['date', 'route_id', 'stop_number', 'car_id'],
            true // уникальный
        );

        $this->batchInsertBaseData();
    }

    public function safeDown(): void
    {
        $this->dropTable('schedules');
    }

    private function batchInsertBaseData()
    {
        // todo - сделать вылидные для таблицы данные
        $this->batchInsert(
            'schedules',
            ['id', 'date', 'car_id', 'route_id', 'stop_id', 'stop_number', 'planned_time', 'actual_time', 'boarded_count'], [
            [1, '2025-08-31', 1, 3, 20, 1, '23:00:00', '23:03:00', 9],
            [2, '2025-08-31', 1, 3, 19, 2, '13:05:00', '13:09:00', 1],
            [3, '2025-08-31', 1, 3, 18, 3, '08:10:00', '08:14:00', 2],
            [4, '2025-08-31', 1, 3, 17, 4, '08:15:00', '08:17:00', 3],
            [5, '2025-08-31', 1, 3, 16, 5, '08:20:00', '08:23:00', 2],
            [6, '2025-08-31', 1, 3, 15, 6, '08:25:00', '08:29:00', 1],
            [7, '2025-08-31', 1, 3, 14, 7, '08:30:00', '08:33:00', 5],
            [8, '2025-08-31', 1, 3, 14, 8, '08:35:00', '08:39:00', 6],
            [9, '2025-08-31', 1, 3, 13, 9, '08:40:00', '08:47:00', 1],
            [10, '2025-08-31', 1, 3, 12, 10, '08:45:00', '08:55:00', 0],
            [11, '2025-08-31', 1, 4, 12, 1, '10:00:00', '10:01:00', 1],
            [12, '2025-08-31', 1, 4, 13, 2, '10:07:00', '10:09:00', 2],
            [13, '2025-08-31', 1, 4, 14, 3, '10:14:00', '10:19:00', 3],
            [14, '2025-08-31', 1, 4, 14, 4, '10:21:00', '10:29:00', 4],
            [15, '2025-08-31', 1, 4, 15, 5, '10:28:00', '10:33:00', 5],
            [16, '2025-08-31', 1, 4, 16, 6, '10:35:00', '10:39:00', 6],
            [17, '2025-08-31', 1, 4, 17, 7, '10:42:00', '10:49:00', 7],
            [18, '2025-08-31', 1, 4, 18, 8, '10:49:00', '10:55:00', 1],
            [19, '2025-08-31', 1, 4, 19, 9, '10:56:00', '10:59:00', 2],
            [20, '2025-08-31', 1, 4, 20, 10, '11:03:00', '11:13:00', 13],
            [31, '2025-10-09', 5, 2, 10, 1, '10:00:00', '10:01:00', 0],
            [32, '2025-10-09', 5, 2, 5, 2, '10:06:00', '10:09:00', 2],
            [33, '2025-10-09', 5, 2, 9, 3, '10:12:00', '10:19:00', 3],
            [34, '2025-10-09', 5, 2, 4, 4, '10:18:00', '10:29:00', 5],
            [35, '2025-10-09', 5, 2, 8, 5, '10:24:00', '10:33:00', 1],
            [36, '2025-10-09', 5, 2, 3, 6, '10:30:00', '10:39:00', 0],
            [37, '2025-10-09', 5, 2, 7, 7, '10:36:00', '10:49:00', 6],
            [38, '2025-10-09', 5, 2, 2, 8, '10:42:00', '10:55:00', 1],
            [39, '2025-10-09', 5, 2, 6, 9, '10:48:00', '10:59:00', 2],
            [40, '2025-10-09', 5, 2, 1, 10, '10:54:00', '11:13:00', 3],
            [41, '2025-10-09', 6, 1, 1, 1, '08:00:00', '08:03:00', 1],
            [42, '2025-10-09', 6, 1, 6, 2, '08:05:00', '08:09:00', 2],
            [43, '2025-10-09', 6, 1, 2, 3, '08:10:00', '08:14:00', 3],
            [44, '2025-10-09', 6, 1, 7, 4, '08:15:00', '08:17:00', 4],
            [45, '2025-10-09', 6, 1, 3, 5, '08:20:00', '08:23:00', 5],
            [46, '2025-10-09', 6, 1, 8, 6, '08:25:00', '08:29:00', 6],
            [47, '2025-10-09', 6, 1, 4, 7, '08:30:00', '08:33:00', 7],
            [48, '2025-10-09', 6, 1, 9, 8, '08:35:00', '08:39:00', 0],
            [49, '2025-10-09', 6, 1, 5, 9, '08:40:00', '08:47:00', 1],
            [50, '2025-10-09', 6, 1, 10, 10, '08:45:00', '08:55:00', 0],
            [54, '2025-10-09', 6, 2, 10, 1, '14:00:00', '14:03:00', 1],
            [55, '2025-10-09', 6, 2, 5, 2, '14:03:00', '14:06:00', 1],
            [56, '2025-10-09', 6, 2, 9, 3, '14:06:00', '14:09:00', 0],
            [57, '2025-10-09', 6, 2, 4, 4, '14:09:00', '14:12:00', 10],
            [58, '2025-10-09', 6, 2, 8, 5, '14:12:00', '14:15:00', 1],
            [59, '2025-10-09', 6, 2, 3, 6, '14:15:00', '14:18:00', 1],
            [60, '2025-10-09', 6, 2, 7, 7, '14:18:00', '14:21:00', 1],
            [61, '2025-10-09', 6, 2, 2, 8, '14:21:00', '14:24:00', 10],
            [62, '2025-10-09', 6, 2, 6, 9, '14:24:00', '14:27:00', 0],
            [63, '2025-10-09', 6, 2, 1, 10, '14:27:00', '14:39:00', 1],
            [64, '2025-10-09', 5, 1, 1, 1, '11:00:00', '11:07:00', 1],
            [65, '2025-10-09', 5, 1, 6, 2, '11:07:00', '11:14:00', 2],
            [66, '2025-10-09', 5, 1, 2, 3, '11:14:00', '11:21:00', 1],
            [67, '2025-10-09', 5, 1, 7, 4, '11:21:00', '11:28:00', 2],
            [68, '2025-10-09', 5, 1, 3, 5, '11:28:00', '11:35:00', 0],
            [69, '2025-10-09', 5, 1, 8, 6, '11:35:00', '11:42:00', 1],
            [70, '2025-10-09', 5, 1, 4, 7, '11:42:00', '11:49:00', 2],
            [71, '2025-10-09', 5, 1, 9, 8, '11:49:00', '11:56:00', 3],
            [72, '2025-10-09', 5, 1, 5, 9, '11:56:00', '12:03:00', 0],
            [73, '2025-10-09', 5, 1, 10, 10, '12:03:00', '12:13:00', 1],
            [74, '2025-10-09', 4, 7, 1, 1, '15:00:00', '15:09:00', 1],
            [75, '2025-10-09', 4, 7, 2, 2, '15:01:00', '15:19:00', 1],
            [76, '2025-10-09', 4, 7, 1, 3, '15:02:00', '15:29:00', 1],
            [77, '2025-10-09', 4, 7, 2, 4, '15:03:00', '15:39:00', 1],
            [78, '2025-10-09', 4, 7, 1, 5, '15:04:00', '15:49:00', 1],
            [79, '2025-10-09', 4, 7, 2, 6, '15:05:00', '15:59:00', 1],
            [80, '2025-10-09', 4, 7, 1, 7, '15:06:00', '16:09:00', 1],
            [81, '2025-10-09', 4, 7, 2, 8, '15:07:00', '16:19:00', 1],
            [82, '2025-10-09', 4, 7, 1, 9, '15:08:00', '16:29:00', 10],
            [83, '2025-10-09', 4, 7, 2, 10, '15:09:00', '16:39:00', 1],
            [84, '2025-10-09', 2, 6, 19, 1, '19:00:00', '19:10:00', 3],
            [85, '2025-10-09', 2, 6, 19, 2, '19:10:00', '19:20:00', 3],
            [86, '2025-10-09', 2, 6, 19, 3, '19:20:00', '19:30:00', 30],
            [87, '2025-10-09', 2, 6, 19, 4, '19:30:00', '19:40:00', 3],
            [88, '2025-10-09', 2, 6, 19, 5, '19:40:00', '19:50:00', 3],
            [89, '2025-10-09', 2, 6, 19, 6, '19:50:00', '20:12:00', 3],
            [90, '2025-10-09', 2, 6, 19, 7, '20:00:00', '20:13:00', 1],
            [91, '2025-10-09', 2, 6, 19, 8, '20:10:00', '20:21:00', 10],
            [92, '2025-10-09', 2, 6, 19, 9, '20:20:00', '20:31:00', 1],
            [93, '2025-10-09', 2, 6, 19, 10, '20:30:00', '20:33:00', 1],
            [94, '2025-10-09', 1, 1, 1, 1, '12:00:00', '12:04:00', 1],
            [95, '2025-10-09', 1, 1, 6, 2, '12:02:00', '12:08:00', 2],
            [96, '2025-10-09', 1, 1, 2, 3, '12:04:00', '12:12:00', 3],
            [97, '2025-10-09', 1, 1, 7, 4, '12:06:00', '12:16:00', 1],
            [98, '2025-10-09', 1, 1, 3, 5, '12:08:00', '12:28:00', 2],
            [99, '2025-10-09', 1, 1, 8, 6, '12:10:00', '12:38:00', 3],
            [100, '2025-10-09', 1, 1, 4, 7, '12:12:00', '12:48:00', 1],
            [101, '2025-10-09', 1, 1, 9, 8, '12:14:00', '12:52:00', 0],
            [102, '2025-10-09', 1, 1, 5, 9, '12:16:00', '12:54:00', 1],
            [103, '2025-10-09', 1, 1, 10, 10, '12:18:00', '12:56:00', 0],
            [104, '2025-10-09', 2, 1, 1, 1, '16:00:00', '16:16:00', 1],
            [105, '2025-10-09', 2, 1, 6, 2, '16:08:00', '16:24:00', 1],
            [106, '2025-10-09', 2, 1, 2, 3, '16:16:00', '16:32:00', 1],
            [107, '2025-10-09', 2, 1, 7, 4, '16:24:00', '16:40:00', 2],
            [108, '2025-10-09', 2, 1, 3, 5, '16:32:00', '16:48:00', 2],
            [109, '2025-10-09', 2, 1, 8, 6, '16:40:00', '16:56:00', 2],
            [110, '2025-10-09', 2, 1, 4, 7, '16:48:00', '17:04:00', 2],
            [111, '2025-10-09', 2, 1, 9, 8, '16:56:00', '17:12:00', 3],
            [112, '2025-10-09', 2, 1, 5, 9, '17:04:00', '17:13:00', 1],
            [113, '2025-10-09', 2, 1, 10, 10, '17:12:00', '17:14:00', 1],
            [114, '2025-10-09', 4, 2, 10, 1, '17:30:00', '18:00:00', 22],
            [115, '2025-10-09', 4, 2, 5, 2, '18:00:00', '18:30:00', 1],
            [116, '2025-10-09', 4, 2, 9, 3, '18:30:00', '19:00:00', 1],
            [117, '2025-10-09', 4, 2, 4, 4, '19:00:00', '19:30:00', 1],
            [118, '2025-10-09', 4, 2, 8, 5, '19:30:00', '20:00:00', 1],
            [119, '2025-10-09', 4, 2, 3, 6, '20:00:00', '20:30:00', 1],
            [120, '2025-10-09', 4, 2, 7, 7, '20:30:00', '21:00:00', 1],
            [121, '2025-10-09', 4, 2, 2, 8, '21:00:00', '21:30:00', 1],
            [122, '2025-10-09', 4, 2, 6, 9, '21:30:00', '22:00:00', 0],
            [123, '2025-10-09', 4, 2, 1, 10, '22:00:00', '22:22:00', 0]
        ]);

        $this->execute("SELECT setval(pg_get_serial_sequence('route_stops', 'id'), (SELECT MAX(id) FROM route_stops));");
    }
}
